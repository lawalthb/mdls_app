# Merit Data Learning System (MDLS) - AI Agent Instructions

## Project Overview

MDLS is a Laravel 10 school management system for managing students, staff, academics, exams, and reporting. Generated with RadSystems, it features role-based access control (RBAC), custom helpers, and extensive Excel/PDF export capabilities.

## Architecture & Key Patterns

### Code Generation Pattern

This project was **generated by RadSystems**, resulting in:

-   Controllers follow strict CRUD patterns with standardized method names (`index`, `view`, `add`, `store`, `edit`, `delete`)
-   Models define field sets as static methods (e.g., `listFields()`, `viewFields()`, `exportListFields()`)
-   Consistent naming: each page action has corresponding field sets (`list` → `listFields()`, `view_first_report` → `viewFirstReportFields()`)

### RBAC System (`app/Http/Middleware/Rbac.php`)

-   **Page-level permissions** checked via `$user->canAccess($page_path)` where `$page_path = "controller/action"`
-   Routes protected by `['auth', 'accountstatus', 'rbac']` middleware
-   Override RBAC with `->withoutMiddleware(['rbac'])` for public masterdetail pages
-   Menu items auto-filtered in `app/Helpers/Menu.php` using `canAccess()` checks
-   Always verify permissions in Blade views: `$can_edit = $user->canAccess("studentdetails/edit")`

### Model Field Management Pattern

Models expose **static field methods** for queries:

```php
// In StudentDetails model
public static function listFields() { return ['user_id', 'firstname', ...]; }
public static function viewFields() { return ['student_details.id AS id', ...]; }
public static function exportViewFirstReportFields() { ... }
```

**Critical**: When adding new page actions, create corresponding field methods following this naming convention.

### Helper Functions (Auto-loaded via `composer.json`)

-   `app/Helpers/Funcs.php` - Utility functions (`print_link()`, `get_value()`, `slugify()`, `guidv4()`)
-   `app/Helpers/Html.php` - View components (`render_menu()`, `export_menus()`, permission-aware menu rendering)
-   `app/Helpers/Menu.php` - Navigation structure as PHP arrays with RBAC integration
-   `app/Helpers/Pagination.php` - Custom pagination
-   `app/Helpers/JWTHelper.php` - JWT encoding/decoding using Firebase JWT

### Base Controller Features (`app/Http/Controllers/Controller.php`)

-   `renderView($view, $data)` - Returns AJAX-compatible responses (partial HTML for AJAX, full page otherwise)
-   `redirect($url, $msg)` - Handles redirects with flash messages, respects AJAX requests
-   `moveUploadedFiles($files, $fieldname)` - Moves uploads from temp to permanent storage
-   `getExportFormat()` - Detects `?export=pdf|csv|excel|print` from query string

### File Upload System (`config/upload.php`)

-   Temp directory: `uploads/temp/`
-   Final destinations: `uploads/files/`, `uploads/photos/`
-   Image auto-resizing: small (100x100), medium (480x480), large (1024x760)
-   S3 support via `league/flysystem-aws-s3-v3`
-   Use `getImgSizePath($src, $size)` helper for responsive images

### Export Architecture

-   Export classes in `app/Exports/` implement Maatwebsite Excel interfaces
-   Follow naming: `{Model}View{PageAction}Export.php` (e.g., `StudentdetailsViewFirstReportExport.php`)
-   Export triggered via `?export=pdf|csv|excel` query params
-   PDF generation uses `barryvdh/laravel-dompdf`
-   HTML::export_menus() in views generates export dropdown buttons

## Development Workflows

### Adding New Page Actions

1. Add route in `routes/web.php` with middleware `['auth', 'accountstatus', 'rbac']`
2. Create controller method following CRUD naming pattern
3. Define field methods in model (e.g., `myActionFields()`, `exportMyActionFields()`)
4. Create Blade view in `resources/views/pages/{model}/`
5. Update permissions in database (if needed for RBAC)

### Working with Blade Views

-   Layout system: `@extends('layouts.app')` (main), `@extends('layouts.report')` (printable)
-   Inject models: `@inject('comp_model', 'App\Models\ComponentsData')`
-   Always check permissions at top: `$can_edit = $user->canAccess("page/action")`
-   Body classes auto-set: `{page_name}-{page_action}` (e.g., `studentdetails-view`)

### Database Queries

-   Use model field methods: `StudentDetails::listFields()` for select statements
-   Join pattern: `$query->join("classes", "student_details.class_id", "=", "classes.id")`
-   Search via model static method: `StudentDetails::search($query, $search)`
-   Pagination: `$query->paginate($limit, StudentDetails::listFields())`

### Authentication & User Context

-   User available globally: `auth()->user()` or `$user` in views
-   User methods: `UserName()`, `UserId()`, `UserEmail()`, `UserRole()`, `canAccess($path)`, `hasRole($roles)`
-   Roles relationship via `user_role_id` FK to `roles` table
-   Permissions stored per role, checked dynamically on each request

## UI & Frontend Architecture

### Styling System

-   **CSS Framework**: Bootstrap 5 with Sandstone theme (`bootstrap-theme-sandstone.css`)
-   **Custom Styles**: `public/css/custom-style.css` (1809 lines of custom CSS)
-   **Icons**: Material Icons (`material-icons.css`)
-   **JavaScript**: jQuery 3.3.1 + Bootstrap 5 bundle
-   **Animations**: Animate.css for transitions

### Layout Components

-   **Main Layout**: `resources/views/layouts/app.blade.php` - Standard admin pages
-   **Report Layout**: `resources/views/layouts/report.blade.php` - Printable reports/cards
-   **AJAX Layout**: `resources/views/layouts/ajax.blade.php` - Modal/drawer content
-   **Header/Footer**: Separate includes via `@include('appheader')` and `@include('appfooter')`

### Page-Specific CSS

Use `@section('pagecss')` in Blade views to add custom CSS:

```blade
@section('pagecss')
<style>
    .custom-class { ... }
</style>
@endsection
```

### AJAX & Modal Patterns

-   Main modal: `#main-page-modal` (right-slide modal for AJAX content)
-   Side drawer: `#sidedrawer-page-modal` (offcanvas for secondary content)
-   Delete confirmation: `#delete-record-modal-confirm`
-   `renderView()` detects AJAX requests and returns partial HTML automatically

### Body Classes for Styling

Each page gets auto-generated classes: `.{page_name}-{page_action}`

```php
// Examples:
// studentdetails-view, studentdetails-edit, classes-index
$body_class = "$page_name-$page_action";
```

### Available CSS Utilities

-   Custom: `.comp-card`, `.cursor-pointer`, `.form-group`, `.form-row`
-   Icon fonts: Material Icons, Simple Line Icons, Font Awesome
-   Galleries: BlueImp Gallery for image viewing
-   Date/Time: Flatpickr for date pickers
-   Summernote for WYSIWYG editing

## Technology Stack

-   **Framework**: Laravel 10 (PHP 8.1+) running on Laragon
-   **Frontend**: Bootstrap 5 (Sandstone theme), Material Icons, jQuery, Vite
-   **Database**: MySQL (Eloquent ORM)
-   **Key Packages**:
    -   `maatwebsite/excel` 3.1.48 - Excel exports
    -   `barryvdh/laravel-dompdf` - PDF generation
    -   `owen-it/laravel-auditing` - Activity logging
    -   `intervention/image` - Image processing

## Common Pitfalls

-   **Don't bypass RBAC middleware** unless explicitly required (masterdetail views)
-   **Always define export field methods** when creating new views/reports
-   **Use model field methods** instead of `SELECT *` to maintain consistency
-   **Check S3 detection** in `getImgSizePath()` when dealing with file paths
-   **Respect the auto-loaded helpers** - they're globally available without imports
-   **Follow RadSystems conventions** - breaking patterns makes maintenance harder

## Development Environment (Laragon)

### Running Commands

```powershell
# Start Laragon services (Apache + MySQL) via GUI

# Database migrations
php artisan migrate

# Clear caches after changes
php artisan cache:clear ; php artisan config:clear ; php artisan view:clear

# View compiled routes
php artisan route:list
```

### Asset Compilation

```powershell
# Development (watch for changes)
npm run dev

# Production build
npm run build
```

## Project Structure Notes

-   **Controllers**: Flat structure in `app/Http/Controllers/` (no subdirectories)
-   **Models**: Mirror database tables in `app/Models/` (ActiveRecord pattern)
-   **Views**: Organized by model: `resources/views/pages/{model}/{action}.blade.php`
-   **Assets**:
    -   Static CSS/JS in `public/css/` and `public/js/`
    -   Source SCSS in `resources/sass/app.scss`
    -   Compiled via Vite
-   **Uploads**: `public/uploads/temp/`, `public/uploads/files/`, `public/uploads/photos/`
